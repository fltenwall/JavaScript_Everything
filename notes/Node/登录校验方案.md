### cookie和session配合完成用户登录

#### 流程

1. 用户使用用户名加密码进行登录，客户端发送请求到服务端
2. 服务端登录校验，并将用户用户名密码登信息写入session
3. 服务端`set-cookie`写入到客户端，将用户标识传递给客户端
4. 客户端访问其他接口时可以通过携带cookie进行访问，一般是用户id
5. 服务端根据cookie中的用户id到session中获取用户信息

#### 为什么需要session？

1. 服务端返回数据时可以会被劫持，如果不是返回用户id而是直接返回用户信息，很可能造成用户隐私泄漏
2. 用户画像等信息可能体积很大，直接返回数据并不合适

### token

 1. token是自定义传递，自己在`Request Header`中写入`Authorization`头信息，不像cookie是HTTP 规范，只要不跨越会自己传递
 2. token需要自己存储(主要通过本地storage存储)，浏览器会自动存储cookie
 3. token默认没有跨域限制

### JWT(Json Web Token)登录验证方案

可以取代cookie+session的用户登录方案

1. 前端发起登录，后端验证用户身份信息之后，返回一个加密的token字符串
2. 前端自行存储这个加密的token(一般存入localStorage)，即使包含用户信息，也因为加密而安全
3. 前端访问服务端接口，就携带这个token作为用户信息
4. 服务端得到token解析，进行用户校验，返回数据给前端

### JWT 和 cookie+session的区别

1. session和cookie的配合校验中，中间只传递用户id，而不传递用户，用户数据存储在session中
2. 而 JWT 的校验方案中，用户信息加密后生成 Token并存储在客户端本地，在通信中互相传递，而在服务器没有对应的集中存储

### session与JWT的对比

session优点：session将用户信息存储在服务端，可快速封禁某用户

session缺点：
1. 多进程，多服务时，由于进程间内存隔离，不好进行数据同步，需要使用第三方缓存比如redis；或者通过进程间通信，实时同步
2. 占用服务器内存，硬件成本高
3. 默认有跨域限制

JWT优点：
1. 不占用服务端内存
2. 多进程、多服务不受影响
3.无跨域限制，更加灵活 

JWT缺点：
1. 用户信息存储在客户端，无法快速封禁某用户，需要通过黑名单封禁用户
2. 如果服务端密钥泄漏，用户信息全部丢失
3. token体积更大，会增加请求数据量

总结：

1. 如果需要严格管理用户信息的场景，应该使用session
2. 没有特殊要求的情况下可以使用token
   

### 单点登录

只要登录一个关联网站，则其他不需要输入用户名和密码全部自动登录

 1. 主域名相同情况下，设置cookie主域名为同一个，例如`domin=baidu.com`，实现跨域共享，则主域名相同的网站都可以登录
   
 2. 主域名不同情况下，使用`SSO` 统一登录验证平台。
   
   (1)假设存在三个主域名不相同的网站 A,B,C，用户登录 A 时发现凭证无效，将用户重定向到 SSO

   (2)用户在 SSO 进行登录校验，并在 SSO 页面进行登录验证。
   
   (3)登录成功后 SSO 平台返回一个ticket(token)，客户端存储ticket到localStorage。
   
   (4)客户端再次并携带ticket访问页面A，而其他页面并不能识别该ticket，将ticket转发给 SSO

   (5)SSO进行ticket验证，验证通过后将校验信息及用户信息返回给页面A

   (6)页面 A 接收到SSO校验信息，并完成登录

   (7)用户携带ticket再访问页面 B ，由于localStorage是跨域不共享的，因此在浏览器端 B 页面的localStorage并没有存储 SSO 签发的ticket凭证，B将请求转发到SSO

   (8)SSO 对用户的ticket进行验证，并返回校验结果和用户信息给服务器 B

   (9)服务器 B返回ticket到浏览器，浏览器在B 页面下的localStorage存储ticket

3. OAuth 2.0

通过第三方验证登录，遵循统一的OAuth 2.0规范

(1)用户访问网站 A

(2)网站 A 允许微信扫描登录

(3)用户扫描登录

(4)网站 A 调用微信登录验证服务，并返回一个token

(5)用户得到token并再次请求登录

(6)网站 A 拿到token并调用微信接口进行校验

(7)微信返回校验信息